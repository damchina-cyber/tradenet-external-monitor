name: TradeNet External Monitor (SEA-aware)

on:
  schedule:
    - cron: "*/10 * * * *"   # má»—i 10 phÃºt
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Test TradeNet + Geo detect + Alert
        shell: pwsh
        env:
          WEBHOOK: ${{ secrets.ALERT_WEBHOOK }}   # Teams/Slack webhook
        run: |
          $Url = "https://tradenet.ccnhub.com/WebApp/TradeNet.UI.Web/ErrorPage.aspx"
          $ThresholdMs = 300

          # ---- Detect runner geo ----
          try {
            $geo = Invoke-RestMethod "https://ipinfo.io/json" -TimeoutSec 10
            $clientCountry = $geo.country
            $clientCity = $geo.city
            $clientOrg = $geo.org
          } catch {
            $clientCountry = "UNK"
            $clientCity = "UNK"
            $clientOrg = "UNK"
          }

          Write-Host "CLIENT=$clientCity-$clientCountry $clientOrg"

          # ---- Call TradeNet ----
          $start = Get-Date
          try {
            $resp = Invoke-WebRequest -Uri $Url -UseBasicParsing -TimeoutSec 20
          } catch {
            Write-Host "::error::Request failed"
            throw
          }
          $end = Get-Date

          $totalMs = [int](($end - $start).TotalMilliseconds)
          $pop = $resp.Headers["X-Volterra-Location"]
          $envoy = $resp.Headers["X-Envoy-Upstream-Service-Time"]

          Write-Host "TOTAL_MS=$totalMs"
          Write-Host "POP=$pop"
          Write-Host "ENVOY_MS=$envoy"

          # ---- SEA logic ----
          $seaCountries = @("SG","VN","MY","TH","ID","PH","HK","JP")
          $isSEA = $seaCountries -contains $clientCountry

          # ---- Decide alert ----
          if ($isSEA -and $totalMs -gt $ThresholdMs) {
            Write-Host "::warning::SEA client slow - $totalMs ms POP=$pop"

            if ($env:WEBHOOK) {
              $time = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss")
              $body = @{
                text = "ðŸš¨ TradeNet latency alert (External)\nTime: $time UTC\nClient: $clientCity-$clientCountry ($clientOrg)\nPOP: $pop\nTotal: ${totalMs}ms\nEnvoy: $envoy"
              } | ConvertTo-Json

              Invoke-RestMethod -Method Post -Uri $env:WEBHOOK -Body $body -ContentType "application/json"
            }
          } else {
            Write-Host "No alert condition met (isSEA=$isSEA, totalMs=$totalMs)"
          }
